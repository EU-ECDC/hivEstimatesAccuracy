The following tables and graphs are on the adjusted for missingness (by Multiple Imputations) data.
Table 5 and Figure 5 show number of diagnoses per year stratified by transmission. Data stratified
by gender are not shown since there were no missing data on gender thus one could refer to Table 1
and Figure 1 of the unadjusted data.

```{r eval = cd4Present, include = cd4Present}
cat("Tables 6 and 7 (and corresponding Figures 6 and 7) show median CD4 cell counts at diagnosis per
    year stratified by gender and transmission category, respectively. Calculations use imputed
    values of transmission category and CD4 counts in cases where they were missing in the original
    data. Year of diagnosis entered through splines in the models used to produce the results of
    Tables/Figures 6 and 7.")
```

**Table 5. Number of diagnoses per year by transmission category and overall**
```{r}
# mitools doesn't like factors with 0 frequency levels
temp_data_mi_transmission[, Transmission := droplevels(Transmission)]

# Fit saturated Poisson model to MI data
data.list <- imputationList(split(temp_data_mi_transmission, by = "Imputation"))

# Main model
models <- with(data.list,
               glm(Count ~ as.factor(Transmission) * splines::ns(DY, df = nsdf),
                   data = temp_data_mi_transmission,
                   family = poisson(link = log)))

# Extract betas and var
vars <- MIextract(models, fun = vcov)
betas <- MIextract(models, fun = coefficients)
# Rubin's rules applied by  MIcombine
t <- MIcombine(betas, vars)
X <- model.matrix(models[[1]]$formula)

# Linear predictor exponentiated to get predicted counts
linpred <- exp(X %*% coef(t))
# Manipulation to end-up with a wide-format dataframe
pred <- cbind(data.list$imputations$`1`, linpred = as.vector(linpred))
pred <- pred[, .(DateOfDiagnosisYear, Transmission, linpred)]
wide <- dcast(pred, DateOfDiagnosisYear ~ Transmission, value.var = "linpred")

# ftab_mi will calculate row percentages and totals
table5 <- ftab_mi(wide, digits = 2, colNamesMapping = c(DateOfDiagnosisYear = "Year of diagnosis",
                                                        HETERO = "Hetero"))

# Show with kable
knitr::kable(table5, align = rep("r", ncol(table5)))
```

**Figure 5. Number of diagnoses per year by transmission category**
```{r}
ggplot(pred) +
  aes(x = DateOfDiagnosisYear, y = linpred, color = Transmission) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Number of diagnoses") +
  scale_color_discrete(name = "Transmission \ncategory", labels = c("Hetero", "IDU", "MSM")) +
  scale_colour_manual("Transmission\ncategory", values = colorPalette[2:5]) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic()
```

```{r eval = cd4Present, include = cd4Present}
table6 <- res.list.gender[[2]]
cat("**Table 6.  Median (IQR) CD4 cell count (cells/microL) by gender**")
knitr::kable(table6, row.names = FALSE, align = rep("r", ncol(table6)),
             col.names = c("Year of diagnosis", "Female", "Male"))

cat("**Figure 6. Median CD4 cell count (cells/microL) by gender***<br />")
ggplot(res.list.gender[[1]]) +
  aes(x = DateOfDiagnosisYear, y = median, color = Gender) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Median CD4 cell count (cells/microL)") +
  scale_color_discrete(name = "Gender", labels = c("Female", "Male")) +
  coord_cartesian(ylim = c(0, cd4YLim)) +
  scale_colour_manual("Gender", values = colorPalette[2:6]) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic()

cat("*<br />**Table 7.  Median (IQR) CD4 cell count (cells/microL) by transmission**")
table7 <- res.list.trans[[2]]
knitr::kable(table7, row.names = FALSE, align = rep("r", ncol(table7)),
             col.names = c("Year of diagnosis", "Hetero", "IDU","MSM"))

cat("**Figure 7. Median CD4 cell count (cells/microL) by transmission**<br />")
ggplot(res.list.trans[[1]]) +
  aes(x = DateOfDiagnosisYear, y = median, color = Transmission) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Median CD4 cell count (cells/microL)") +
  scale_color_discrete(name = "Transmission\ncategory", labels = c("Hetero", "IDU","MSM")) +
  coord_cartesian(ylim = c(0, cd4YLim)) +
  scale_colour_manual("Transmission\ncategory", values = colorPalette[2:6]) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic()
```
